<!DOCTYPE html>

<!--
  Google HTML5 slide template

  Authors: Luke Mahé (code)
           Marcin Wichary (code and design)

           Dominic Mazzoni (browser compatibility)
           Charles Chen (ChromeVox support)

  URL: http://code.google.com/p/html5slides/
-->

<html>
  <head>
    <title>Presentation</title>

    <meta charset='utf-8'>
    <script
      src='slides.js'></script>
  </head>

  <style>

    .slides.template-bekk > article:not(.nobackground):not(.biglogo) {
      background: url(images/bekk-logo-small.png) 710px 625px no-repeat;
      background-color: white;
    }

    q.small {
      font-size: 1.1em;
    }


  </style>

  <body style='display: none'>

    <section class='slides layout-regular template-bekk'>

      <article>
        <h1>
          Deklarativ konfigurasjonsstyring med Puppet
        </h1>
        <p>
          Ole Christian Rynning og Eivind Uggedal
          <br>
          Bekk Consulting
          <br>
          7. september 2011
        </p>
      </article>

      <article>
        <h3>
          Bakgrunn
        </h3>
        <h4>
          Ole Christian Rynning
        </h4>
        <p>
          Utvikler med erfaring fra drift. Automatisert systemarkitekturen til Bring Development Team med hjelp av Puppet.
        </p>
        <h4>
          Eivind Uggedal
        </h4>
        <p>
          Styrer konfigurasjon av rundt 10 servere for blant annet
          <a href="http://mediaqueri.es">mediaqueri.es</a> og
          <a href="http://wasitup.com">wasitup.com</a> samt
          MacBookPro/Air med Puppet.
        </p>
      </article>

      <article>
        <h3>
          Infrastruktur som kode
        </h3>
        <ul>
          <li>
            En av byggestenene for &aring; f&aring; ...
          </li>
        </ul>
      </article>

      <article>
        <h3>
          Deklarativ konfigurasjonsstyring
        </h3>
        <ul>
          <li>
            Deklarativ fremfor imperativ
          </li>
          <li>
            Gjenskape et milj&oslash; fra forskjellige utgangspunkt
          </li>
        </ul>
<div style="width: 55%; float:left; margin-right: 5%;">
<pre>
apt-get install vim

echo "set nocp" >> /etc/vim/vimrc</pre>
<pre>
yum install vim

echo "set nocp" >> /etc/vim/vimrc</pre>
</div>

<div style="width: 40%; float:left;">
<pre>
package { "vim":
  ensure => present,
}

file { "/etc/vim/vimrc":
  content => "set nocp",
}</pre>
</div>

      </article>

      <article>
        <h3>
          Deklarative konfigurasjonsverkt&oslash;y
        </h3>
        <ul>
          <li>
            CFEngine
            <ul>
              <li>
                F&oslash;rste deklarative konfigurasjonsverkt&oslash;y
                (1993)
              </li>
              <li>
                Lav-niv&aring;
              </li>
            </ul>
          </li>
          <li>
            Puppet
            <ul>
              <li>
                Skriver &oslash;nsket konfigurasjon i eget DSL
              </li>
              <li>
                Lettvekt. Ingen avhengigheter for Puppet server.
              </li>
            </ul>
          </li>
          <li>
            Chef
            <ul>
              <li>
                Skriver &oslash;nsket konfigurasjon i Ruby
              </li>
              <li>
                En del tyngre. Krever CouchDB, Solr, RabbitMQ for
                Chef server.
              </li>
            </ul>
          </li>
        </ul>
      </article>

      <article style="background: url(images/puppets.jpg) 0 0 no-repeat;">
        <h1 style="color: #fff; margin-top: 50px;">
          Puppet
        </h1>
        <div class='source'>
          Source: http://flic.kr/p/6qy7W2
        </div>
      </article>

      <article>
        <h3>
          Puppet arkitektur
        </h3>
        <ul>
          <li>
            Klient/Server
          </li>
          <li>
            Frittst&aring;ende
          </li>
        </ul>
        <dl>
          <dt>
          Kj&oslash;rer p&aring;:
          </dt>
          <dd>
          Linux (Debian, Ubuntu, RHEL, Gentoo, et. al.)
          </dd>
          <dd>
          BSD (FreeBSD, OpenBSD, NetBSD)
          </dd>
          <dd>
          OS X
          </dd>
          <dd>
          Solaris, AIX, HP-UX
          </dd>
          <dd>
          Windows (ekstremt eksperimentell)
          </dd>
        </dl>
      </article>

      <article>
        <h3>Ressurser</h3>
        <p>
          Har <code>type</code>, <code>navn</code> og <code>parametere</code>
        </p>
        <section>
<pre>
package { "zsh":
  ensure => present,
}</pre>
        </section>
      </article>

      <article>
        <h3>Frittstående bruk</h3>
        <section>
          <pre>apt-get install puppet</pre>
        </section>
        <section>
          <pre>
cat &lt;&lt; EOX &gt;&gt; zsh.pp
package { "zsh":
  ensure => present,
}
EOX
puppet apply zsh.pp</pre>
        </section>
      </article>

      <article>
        <h3>Ulike ressurstyper</h3>
        <section>
        <pre>
user { "oc":
  ensure     => present,
  uid        => 1337,
  home       => "/home/oc",
  managehome => true,
  password   => '$6$xSZZx34H$7Wv2cIRg/MP2BGGp64OOmjxL6vxfl2QxNsmsRylxWsyA4maIp20lot3rw76Bl75DXfqltqDQUwNNWmHSTlEuJ/',
}

cron { "poor-mans-http-ping":
  command => "curl -s http://wasitup.com/ > /dev/null 2>&amp;1",
  minute  => "*/1", # Sjekk hvert minutt
}</pre>
        </section>
      </article>

      <article>
        <h3>Generiske ressurstyper</h3>
        <p>
          Byggestener for å beskrive ressurser som ikke er
          innebygd i Puppet.
        </p>
        <section>
          <pre>
file { "/etc/timezone":
  content => "Europe/Oslo\n",
}

exec { "reconfigure-tzdata":
  command => "/usr/sbin/dpkg-reconfigure -f noninteractive tzdata",
}</pre>
        </section>
      </article>

      <article>
        <h3>Avhengigheter mellom ressurser</h3>
        <p><code>require</code> / <code>before</code> og <code>notify</code> / <code>subscribe</code>
        <section>
          <pre>
file { "/etc/timezone":
  content => "Europe/Oslo\n",
}

exec { "reconfigure-tzdata":
  command => "/usr/sbin/dpkg-reconfigure -f noninteractive tzdata",
  subscribe => File["/etc/timezone"],
  require => File["/etc/timezone"],
  refreshonly => true,
}</pre>

          <pre>
File["/etc/timezone"] ->  Exec["reconfigure-tzdata"] # requirrequire
File["/etc/timezone"] ~>  Exec["reconfigure-tzdata"] # subscribe</pre>
        </section>
      </article>

      <article>
        <h3>Templater og variabler</h3>
        <section>
          <pre>
$port = 22
$allowed_users = ["eivind", "oc"] # Tillat innlogging

package { "openssh-server":
  ensure => present,
}

file { "/etc/ssh/sshd_config":
  content => template("sshd_config.erb"),
  require => Package["openssh-server"],
}

service { ssh:
  ensure    => running,
  hasstatus => true,
  subscribe => [Package["openssh-server"],
                File["/etc/ssh/sshd_config"]],
}</pre>
        </section>
      </article>
      <article>
        <h3>templates/sshd_config.erb</h3>
        <section>
<pre>
Port &lt;%= port %&gt;

Protocol 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
UsePrivilegeSeparation yes

StrictModes yes
PubkeyAuthentication yes
PermitRootLogin no

&lt;% if allowed_users.any? %&gt;
AllowUsers &lt;%= allowed_users.join(" ") %&gt;
&lt;% end %&gt;

...
</pre>
        </section>
      </article>

      <article>
        <h3>Kjør kode med templates</h3>
        <section>
          <pre>puppet apply --templatedir=templates templates_and_variables.pp</pre>
        </section>
      </article>

      <article>
        <h3>Klasser: samlinger av ressurser (singleton).</h3>
        <section>
          <pre>
class nginx {
  package { nginx:
    ensure => present,
  }
  file { "/etc/nginx/nginx.conf":
    source  => "puppet:///modules/nginx/nginx.conf",
    require => Package[nginx],
  }
  service { nginx:
    ensure    => running,
    enable    => true,
    pattern   => "nginx: master process",
    subscribe => File["/etc/nginx/nginx.conf"],
    require   => File["/etc/nginx/nginx.conf"],
  }
}</pre>
        </section>
      </article>

      <article>
        <h3>Moduler</h3>
        <p>Den foretrukne m&aring;ten &aring; strukturere konfigurasjon på er å plassere det i moduler.</p>
        <section>
<pre>
modules/
    nginx/
      manifests/
        init.pp
      files/
        nginx.conf
      templates/
        site.conf.erb
    jvm/
      manifests/
        init.pp
        jdk.pp
        jetty.pp
</pre>
        </section>
      </article>

      <article>
        <h3>Bruk av klasser</h3>
        <section>
          <pre>include nginx</pre>
        </section>

        <h3>Kjør kode med moduler</h3>
        <section>
          <pre>puppet apply --modulepath=modules nginx.pp</pre>
        </section>
      </article>

      <article>
        <h3>Opprette egne ressurstyper med define</h3>
        <section>
<pre>define nginx::site($domain, $root) {
  file { $root:
    ensure  => directory,
  }
  file { "/etc/nginx/sites-available/${name}.conf":
    ensure  => present,
    content => template("nginx/site.conf.erb"),
    require => File[$root],
    notify  => Service[nginx],
  }
  file { "/etc/nginx/sites-enabled/${name}.conf":
    ensure  => link,
    target  => "/etc/nginx/sites-available/${name}.conf",
    require => File["/etc/nginx/sites-available/${name}.conf"],
    notify  => Service[nginx],
  }
}</pre>
        </section>
      </article>

      <article>
        <h3>nginx/templates/site.conf.erb</h3>
        <section>
          <pre>
server {
  listen 80;
  server_name &lt;%= domain %&gt;;

  access_log  /var/log/nginx/&lt;%= name %&gt;.access.log;

  location / {
    root &lt;%= root %&gt;;
    index  index.html;
  }
}</pre>
        </section>
      </article>

      <article>
        <h3>Bruk av egendefinerte ressurstyper</h3>
        <section>
<pre>nginx::site { "demo":
  domain => "demo.muda.no",
  root => "/var/www/muda",
}</pre>
        </section>
      </article>

      <article>
        <h3>Sammendrag av Puppet DSL</h3>

        <ul>
          <li>
            Innebygde ressurstyper
            <ul>
              <li>
                <code>package</code>,
                <code>user</code>,
                <code>cron</code>,
                <code>service</code>,
                <code>file</code> og
                <code>exec</code>.
              </li>
            </ul>
          </li>
          <li>
            Avhengighter
            <ul>
              <li>
                <code>require</code>,
                <code>before</code>,
                <code>subscribe</code> og
                <code>notify</code>.
              </li>
            </ul>
          </li>
          <li>
            Innebygde funksjoner
            <ul>
              <li>
                <code>template()</code>
              </li>
            </ul>
          </li>
          <li>Klasser (<code>class</code>)</li>
          <li>Egendefinerte ressurstyper (<code>define</code>)</li>
        </ul>
      </article>

      <article>
        <h3>Mer Puppet DSL</h3>

        <ul>
          <li>
            Innebygde ressurstyper
            <ul>
              <li>
                <code>host</code>,
                <code>mount</code>,
                <code>ssh_authorized_key</code> og
                <code>sshkey</code>.
              </li>
            </ul>
          </li>
          <li>
            Innebygde funksjoner
            <ul>
              <li>
                <code>inline_template()</code>,
                <code>file()</code>,
                <code>regsubst()</code>,
                <code>split()</code> og
                <code>versioncmp()</code>.
              </li>
            </ul>
          </li>
          <li>Arrays (<code>["en", "to"]</code>)</li>
          <li>Hashes (<code>{"n&oslash;kkel" => "verdi", "a" => "b"}</code>)</li>
          <li>
            Flytkontroll (<code>case</code> og
            <code>if/elsif/else</code>)
          </li>
          <li>Virtuelle ressurser (<code>@ressurs { "navn": }</code>)</li>
          <li>Eksporterte ressurser (<code>@@ressurs { "navn": }</code>)</li>
        </ul>
      </article>

      <article>
        <h3>Klient / Server (puppet agent / puppet master)</h3>
        <ul>
          <li>Én Puppet-master (server)</li>
          <li>Mange Puppet-agenter (klienter) som henter konfigurasjon fra master over et REST API</li>
          <li>SSL-sertifikatbasert autentisering. Agenter må signeres/godkjennes av Master</li>
        </ul>
      </article>

      <article>
        <h3>Typisk klient / server oppsett</h3>
        <section>
          <img src="images/puppet-arch.png">
        </section>
      </article>

      <article>
        <h3>manifests/nodes.pp</h3>
        <section>
          <pre>
node webserver {
  include nginx
  nginx::site { "muda":
    domain => "www.muda.no",
    root => "/var/www/muda.no",
  }
}
node appserver {
  include java
  jvm::jetty { "example":
    secret => "fe9dee1f3a0c22dfff0aec9838f7e70e",
    port => 9000,
  }
}
node "web1.muda.no" inherits webserver
node "app1.muda.no" inherits appserver
node "app2.muda.no" inherits appserver
</pre>
        </section>
      </article>

      <article>
        <p>Agenter har ikke tilgang til kildekoden for konfigurasjonen:</p>
        <ol>
          <li>Agent henter 'facts' om systemet sitt fra master</li>
          <li>Agent forespør en konfigurasjonskatalog fra master</li>
          <li>Master kompilerer kildekoden om til en konfigurasjonskatalog og sender til agent</li>
          <li>Agent pakker opp konfigurasjonskatalogen som ender opp i kjørbar konfigurasjon</li>
        </ol>
      </article>

      <article style="background: url(images/juggler.jpg) 0 0 no-repeat;">
        <h1 style="color: #fff; margin-top: 50px;">
          Demo
        </h1>
        <div class='source'>
          Source: http://flic.kr/p/2fiWvK
        </div>
      </article>

      <article>
        <h3>
          Debugging av Puppet
        </h3>
        <p>
          Start master med:
          <pre><code>puppet master --no-deamonize</pre></code>
          Start agenter med:
          <pre><code>puppet --debug --verbose file.pp
puppet --parseonly file.pp</pre></code>
          Log fra manifest filer:
<pre><code>notice("The value is: ${yourvar}")   # Log til master
notify{"The value is: ${yourvar}": } # Log til klient</pre></code>

        </p>
      </article>

      <article style="background: url(images/question.jpg) 0 0 no-repeat;">
        <div class='source'>
          Source: http://flic.kr/p/ubG6g
        </div>
      </article>

      <article>
        <h3>
          Slides og kode
        </h3>
        <p>
          <a href="https://github.com/bekkopen/jz11-puppet">
            github.com/bekkopen/jz11-puppet
          </a>
        </p>
      </article>

  </body>
</html>
